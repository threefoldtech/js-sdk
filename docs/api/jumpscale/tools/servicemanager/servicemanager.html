<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />
<meta name="generator" content="pdoc 0.10.0" />
<title>jumpscale.tools.servicemanager.servicemanager API documentation</title>
<meta name="description" content="Description â€¦" />
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/sanitize.min.css" integrity="sha256-PK9q560IAAa6WVRRh76LtCaI8pjTJ2z11v0miyNNjrs=" crossorigin>
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/typography.min.css" integrity="sha256-7l/o7C8jubJiy74VsKTidCy1yBkRtiUGbVkYBylBqUg=" crossorigin>
<link rel="stylesheet preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/styles/github.min.css" crossorigin>
<style>:root{--highlight-color:#fe9}.flex{display:flex !important}body{line-height:1.5em}#content{padding:20px}#sidebar{padding:30px;overflow:hidden}#sidebar > *:last-child{margin-bottom:2cm}.http-server-breadcrumbs{font-size:130%;margin:0 0 15px 0}#footer{font-size:.75em;padding:5px 30px;border-top:1px solid #ddd;text-align:right}#footer p{margin:0 0 0 1em;display:inline-block}#footer p:last-child{margin-right:30px}h1,h2,h3,h4,h5{font-weight:300}h1{font-size:2.5em;line-height:1.1em}h2{font-size:1.75em;margin:1em 0 .50em 0}h3{font-size:1.4em;margin:25px 0 10px 0}h4{margin:0;font-size:105%}h1:target,h2:target,h3:target,h4:target,h5:target,h6:target{background:var(--highlight-color);padding:.2em 0}a{color:#058;text-decoration:none;transition:color .3s ease-in-out}a:hover{color:#e82}.title code{font-weight:bold}h2[id^="header-"]{margin-top:2em}.ident{color:#900}pre code{background:#f8f8f8;font-size:.8em;line-height:1.4em}code{background:#f2f2f1;padding:1px 4px;overflow-wrap:break-word}h1 code{background:transparent}pre{background:#f8f8f8;border:0;border-top:1px solid #ccc;border-bottom:1px solid #ccc;margin:1em 0;padding:1ex}#http-server-module-list{display:flex;flex-flow:column}#http-server-module-list div{display:flex}#http-server-module-list dt{min-width:10%}#http-server-module-list p{margin-top:0}.toc ul,#index{list-style-type:none;margin:0;padding:0}#index code{background:transparent}#index h3{border-bottom:1px solid #ddd}#index ul{padding:0}#index h4{margin-top:.6em;font-weight:bold}@media (min-width:200ex){#index .two-column{column-count:2}}@media (min-width:300ex){#index .two-column{column-count:3}}dl{margin-bottom:2em}dl dl:last-child{margin-bottom:4em}dd{margin:0 0 1em 3em}#header-classes + dl > dd{margin-bottom:3em}dd dd{margin-left:2em}dd p{margin:10px 0}.name{background:#eee;font-weight:bold;font-size:.85em;padding:5px 10px;display:inline-block;min-width:40%}.name:hover{background:#e0e0e0}dt:target .name{background:var(--highlight-color)}.name > span:first-child{white-space:nowrap}.name.class > span:nth-child(2){margin-left:.4em}.inherited{color:#999;border-left:5px solid #eee;padding-left:1em}.inheritance em{font-style:normal;font-weight:bold}.desc h2{font-weight:400;font-size:1.25em}.desc h3{font-size:1em}.desc dt code{background:inherit}.source summary,.git-link-div{color:#666;text-align:right;font-weight:400;font-size:.8em;text-transform:uppercase}.source summary > *{white-space:nowrap;cursor:pointer}.git-link{color:inherit;margin-left:1em}.source pre{max-height:500px;overflow:auto;margin:0}.source pre code{font-size:12px;overflow:visible}.hlist{list-style:none}.hlist li{display:inline}.hlist li:after{content:',\2002'}.hlist li:last-child:after{content:none}.hlist .hlist{display:inline;padding-left:1em}img{max-width:100%}td{padding:0 .5em}.admonition{padding:.1em .5em;margin-bottom:1em}.admonition-title{font-weight:bold}.admonition.note,.admonition.info,.admonition.important{background:#aef}.admonition.todo,.admonition.versionadded,.admonition.tip,.admonition.hint{background:#dfd}.admonition.warning,.admonition.versionchanged,.admonition.deprecated{background:#fd4}.admonition.error,.admonition.danger,.admonition.caution{background:lightpink}</style>
<style media="screen and (min-width: 700px)">@media screen and (min-width:700px){#sidebar{width:30%;height:100vh;overflow:auto;position:sticky;top:0}#content{width:70%;max-width:100ch;padding:3em 4em;border-left:1px solid #ddd}pre code{font-size:1em}.item .name{font-size:1em}main{display:flex;flex-direction:row-reverse;justify-content:flex-end}.toc ul ul,#index ul{padding-left:1.5em}.toc > ul > li{margin-top:.5em}}</style>
<style media="print">@media print{#sidebar h1{page-break-before:always}.source{display:none}}@media print{*{background:transparent !important;color:#000 !important;box-shadow:none !important;text-shadow:none !important}a[href]:after{content:" (" attr(href) ")";font-size:90%}a[href][title]:after{content:none}abbr[title]:after{content:" (" attr(title) ")"}.ir a:after,a[href^="javascript:"]:after,a[href^="#"]:after{content:""}pre,blockquote{border:1px solid #999;page-break-inside:avoid}thead{display:table-header-group}tr,img{page-break-inside:avoid}img{max-width:100% !important}@page{margin:0.5cm}p,h2,h3{orphans:3;widows:3}h1,h2,h3,h4,h5,h6{page-break-after:avoid}}</style>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/highlight.min.js" integrity="sha256-Uv3H6lx7dJmRfRvH8TH6kJD1TSK1aFcwgx+mdg3epi8=" crossorigin></script>
<script>window.addEventListener('DOMContentLoaded', () => hljs.initHighlighting())</script>
</head>
<body>
<main>
<article id="content">
<header>
<h1 class="title">Module <code>jumpscale.tools.servicemanager.servicemanager</code></h1>
</header>
<section id="section-intro">
<h3 id="description">Description</h3>
<p>Service manager is the service that monitors and manages background services through gevent greenlets.
Each service defines an interval to define the period of the service and defines also a job method that is run each period.
Any service should:
- Inherit from <code><a title="jumpscale.tools.servicemanager.servicemanager.BackgroundService" href="#jumpscale.tools.servicemanager.servicemanager.BackgroundService">BackgroundService</a></code> class defined here: <code>from <a title="jumpscale.tools.servicemanager.servicemanager" href="#jumpscale.tools.servicemanager.servicemanager">jumpscale.tools.servicemanager.servicemanager</a> import <a title="jumpscale.tools.servicemanager.servicemanager.BackgroundService" href="#jumpscale.tools.servicemanager.servicemanager.BackgroundService">BackgroundService</a></code>
- Define an interval in the constructor
- Implement the abstract <code>job</code> method of the <code><a title="jumpscale.tools.servicemanager.servicemanager.BackgroundService" href="#jumpscale.tools.servicemanager.servicemanager.BackgroundService">BackgroundService</a></code> base class.</p>
<h3 id="how-it-schedules-services">How it schedules services</h3>
<p>The service manager uses gevent greenlets to run jobs. It spawns the job in a greenlet after its interval period.
Rescheduling the service job is done in by linking a callback to the greenlet which is run after the greenlet finishes.
After the greenlet finishes execution the callback is fired which schedules the job to be run again after another interval.</p>
<p>To add a service to the service manager you should call the <code>add_service</code> method which takes the package name and package path as parameters.
It loads the file in this path as a module and gets the service object defined in the service.py file.</p>
<h3 id="immediately-schedule-service">Immediately schedule service</h3>
<p>The services first start will be after the requested interval.
If you need to make the service first interval immediately on server start, It can be added in your service by adding</p>
<pre><code class="language-python3">self.schedule_on_start = True
</code></pre>
<p>in your service init after calling super() init.</p>
<h3 id="example-service">Example service</h3>
<pre><code class="language-python3">from jumpscale.tools.servicemanager.servicemanager import BackgroundService

class TestService(BackgroundService):
    def __init__(self, interval=&quot;* * * * *&quot;, *args, **kwargs):
        '''
            Test service that runs every 1 minute
        '''
        super().__init__(interval, *args, **kwargs)
        self.schedule_on_start = True # immediately schedule the service (optional step and the line can be removed, default=False)

    def job(self):
        print(&quot;[Test Service] Done&quot;)

service = TestService()
</code></pre>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">&#34;&#34;&#34;
### Description

Service manager is the service that monitors and manages background services through gevent greenlets.
Each service defines an interval to define the period of the service and defines also a job method that is run each period.
Any service should:
- Inherit from `BackgroundService` class defined here: `from jumpscale.tools.servicemanager.servicemanager import BackgroundService`
- Define an interval in the constructor
- Implement the abstract `job` method of the `BackgroundService` base class.

### How it schedules services

The service manager uses gevent greenlets to run jobs. It spawns the job in a greenlet after its interval period.
Rescheduling the service job is done in by linking a callback to the greenlet which is run after the greenlet finishes.
After the greenlet finishes execution the callback is fired which schedules the job to be run again after another interval.

To add a service to the service manager you should call the `add_service` method which takes the package name and package path as parameters.
It loads the file in this path as a module and gets the service object defined in the service.py file.

### Immediately schedule service

The services first start will be after the requested interval.
If you need to make the service first interval immediately on server start, It can be added in your service by adding

```python3
self.schedule_on_start = True
```

in your service init after calling super() init.


### Example service

```python3
from jumpscale.tools.servicemanager.servicemanager import BackgroundService

class TestService(BackgroundService):
    def __init__(self, interval=&#34;* * * * *&#34;, *args, **kwargs):
        &#39;&#39;&#39;
            Test service that runs every 1 minute
        &#39;&#39;&#39;
        super().__init__(interval, *args, **kwargs)
        self.schedule_on_start = True # immediately schedule the service (optional step and the line can be removed, default=False)

    def job(self):
        print(&#34;[Test Service] Done&#34;)

service = TestService()
```
&#34;&#34;&#34;

from numbers import Real
from math import ceil
from abc import ABC, abstractmethod
from signal import SIGTERM, SIGKILL
from crontab import CronTab
import gevent
from gevent.pool import Pool

from jumpscale.loader import j
from jumpscale.core.base import Base
from multiprocessing import cpu_count


class BackgroundService(ABC):
    def __init__(self, interval=60, *args, **kwargs):
        &#34;&#34;&#34;Abstract base class for background services managed by the service manager

        Arguments:
            interval (int | CronTab object | str): scheduled job is executed every interval in seconds / CronTab object / CronTab-formatted string
        &#34;&#34;&#34;
        self.interval = interval
        self.schedule_on_start = False

    @abstractmethod
    def job(self):
        &#34;&#34;&#34;
        Background job to be scheduled.
        Should be implemented by any service that inherits from this class
        &#34;&#34;&#34;
        pass


# TODO: add support for non-periodic tasks
# TODO: configurable services
# TODO: add support for services not in packages
class ServiceManager(Base):
    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        self.services = {}  # service objects
        self._scheduled = {}  # greenlets of scheduled services
        self._running = {}  # greenlets of currently running services
        self._pool = Pool(cpu_count())

    @staticmethod
    def seconds_to_next_interval(interval):
        &#34;&#34;&#34;Helper method to get seconds remaining to next_interval

        Arguments:
            interval (Any): next interval to which seconds remaining is calculated

        Returns:
            Real: number of seconds remaining until next interval

        Raises:
            ValueError: when the type of interval is not Real / CronTab object / CronTab string format
        &#34;&#34;&#34;
        if isinstance(interval, Real):
            return interval
        elif isinstance(interval, str):
            try:
                return CronTab(interval).next(default_utc=True)
            except Exception as e:
                raise j.exceptions.Value(str(e))
        elif isinstance(interval, CronTab):
            return interval.next(default_utc=True)
        else:
            raise j.exceptions.Runtime(f&#34;Unsupported interval type: {type(interval)}&#34;)

    @staticmethod
    def _load_service(path):
        &#34;&#34;&#34;Load the module in the service file path and get the service object

        Arguments:
            path (str): path of the service file

        Returns:
            service: service object defined in the service file
        &#34;&#34;&#34;
        module = j.tools.codeloader.load_python_module(path, force_reload=True)
        return module.service

    @staticmethod
    def __on_exception(greenlet):
        &#34;&#34;&#34;Callback to handle exception raised by service greenlet

        Arguments:
            greenlet (Greenlet): greenlet object
        &#34;&#34;&#34;
        message = f&#34;Service {greenlet.service.name} raised an exception: {greenlet.exception}&#34;
        j.tools.alerthandler.alert_raise(app_name=&#34;servicemanager&#34;, message=message, alert_type=&#34;exception&#34;)
        j.logger.exception(f&#34;Service {greenlet.service.name} raised an exception&#34;, exception=greenlet.exception)

    def __callback(self, greenlet):
        &#34;&#34;&#34;Callback runs after greenlet finishes execution

        Arguments:
            greenlet (Greenlet): greenlet object
        &#34;&#34;&#34;
        greenlet.unlink(self.__callback)
        if greenlet.service.name in self._running:
            self._running.pop(greenlet.service.name)

    def _schedule_service(self, service):
        &#34;&#34;&#34;Runs a service job and schedules it to run again every period (interval) specified by the service

        Arguments:
            service (BackgroundService): background service object
        &#34;&#34;&#34;
        if service.name not in self._running:
            greenlet = self._pool.apply_async(service.job)
            greenlet.link(self.__callback)
            greenlet.link_exception(self.__on_exception)
            greenlet.start()
            self._running[service.name] = greenlet
            self._running[service.name].service = service
        next_start = ceil(self.seconds_to_next_interval(service.interval))
        self._scheduled[service.name] = gevent.spawn_later(next_start, self._schedule_service, service=service)

    def start(self):
        &#34;&#34;&#34;Start the service manager and schedule default services
        &#34;&#34;&#34;
        # schedule default services
        for service in self.services.values():
            next_start = ceil(self.seconds_to_next_interval(service.interval))
            self._scheduled[service.name] = gevent.spawn_later(next_start, self._schedule_service, service=service)

    def stop(self):
        &#34;&#34;&#34;Stop all background services
        &#34;&#34;&#34;
        j.logger.info(&#34;Stopping background services&#34;)
        for service in list(self.services.keys()):
            self.stop_service(service)
        j.logger.info(&#34;Done stopping the background services&#34;)

    def add_service(self, service_name, service_path):
        &#34;&#34;&#34;Add a new background service to be managed and scheduled by the service manager

        Arguments:
            service_path (str): absolute path of the service file
        &#34;&#34;&#34;

        service = self._load_service(service_path)
        service.name = service_name

        if service in self.services.values():
            j.logger.debug(f&#34;Service {service.name} is already running. Reloading...&#34;)
            self.stop_service(service.name)

        next_start = 0 if service.schedule_on_start else ceil(self.seconds_to_next_interval(service.interval))
        self._scheduled[service.name] = gevent.spawn_later(next_start, self._schedule_service, service=service)
        self.services[service.name] = service
        j.logger.debug(f&#34;Service {service.name} is added.&#34;)

    def stop_service(self, service_name, block=True):
        &#34;&#34;&#34;Stop a running background service and unschedule it if it&#39;s scheduled to run again

        Arguments:
            service_name (str): name of the service to be stopped
            block (bool): wait for service job to finish. if False, service job will be killed without waiting
        &#34;&#34;&#34;
        if service_name not in self.services:
            raise j.exceptions.Value(f&#34;Service {service_name} is not running&#34;)

        # unschedule service if it&#39;s scheduled to run again
        if service_name in self._scheduled:
            greenlet = self._scheduled[service_name]
            greenlet.unlink(self.__callback)
            greenlet.kill()
            if not greenlet.dead:
                raise j.exceptions.Runtime(&#34;Failed to unschedule greenlet&#34;)
            self._scheduled.pop(service_name)

        # wait for service to finish if it&#39;s already running
        if service_name in self._running:
            greenlet = self._running[service_name]
            greenlet.unlink(self.__callback)
            if block:
                try:
                    j.logger.info(f&#34;Waiting the service {service_name} to finish&#34;)
                    greenlet.join()
                    j.logger.info(f&#34;Done waiting the service {service_name}&#34;)
                except Exception as e:
                    raise j.exceptions.Runtime(f&#34;Exception on waiting for greenlet: {str(e)}&#34;)
            else:
                try:
                    greenlet.kill()
                except Exception as e:
                    raise j.exceptions.Runtime(f&#34;Exception on killing greenlet: {str(e)}&#34;)
                if not greenlet.dead:
                    raise j.exceptions.Runtime(&#34;Failed to kill running greenlet&#34;)

        self.services.pop(service_name)</code></pre>
</details>
</section>
<section>
</section>
<section>
</section>
<section>
</section>
<section>
<h2 class="section-title" id="header-classes">Classes</h2>
<dl>
<dt id="jumpscale.tools.servicemanager.servicemanager.BackgroundService"><code class="flex name class">
<span>class <span class="ident">BackgroundService</span></span>
<span>(</span><span>interval=60, *args, **kwargs)</span>
</code></dt>
<dd>
<div class="desc"><p>Helper class that provides a standard way to create an ABC using
inheritance.</p>
<p>Abstract base class for background services managed by the service manager</p>
<h2 id="arguments">Arguments</h2>
<p>interval (int | CronTab object | str): scheduled job is executed every interval in seconds / CronTab object / CronTab-formatted string</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">class BackgroundService(ABC):
    def __init__(self, interval=60, *args, **kwargs):
        &#34;&#34;&#34;Abstract base class for background services managed by the service manager

        Arguments:
            interval (int | CronTab object | str): scheduled job is executed every interval in seconds / CronTab object / CronTab-formatted string
        &#34;&#34;&#34;
        self.interval = interval
        self.schedule_on_start = False

    @abstractmethod
    def job(self):
        &#34;&#34;&#34;
        Background job to be scheduled.
        Should be implemented by any service that inherits from this class
        &#34;&#34;&#34;
        pass</code></pre>
</details>
<h3>Ancestors</h3>
<ul class="hlist">
<li>abc.ABC</li>
</ul>
<h3>Subclasses</h3>
<ul class="hlist">
<li><a title="jumpscale.packages.admin.services.alerts_notifier.AlertsNotifier" href="../../packages/admin/services/alerts_notifier.html#jumpscale.packages.admin.services.alerts_notifier.AlertsNotifier">AlertsNotifier</a></li>
<li><a title="jumpscale.packages.admin.services.diskcheck.DiskCheckService" href="../../packages/admin/services/diskcheck.html#jumpscale.packages.admin.services.diskcheck.DiskCheckService">DiskCheckService</a></li>
<li><a title="jumpscale.packages.admin.services.heartbeat.HeartBeatService" href="../../packages/admin/services/heartbeat.html#jumpscale.packages.admin.services.heartbeat.HeartBeatService">HeartBeatService</a></li>
<li><a title="jumpscale.packages.admin.services.notifier.Notifier" href="../../packages/admin/services/notifier.html#jumpscale.packages.admin.services.notifier.Notifier">Notifier</a></li>
<li><a title="jumpscale.packages.admin.services.stellar.StellarService" href="../../packages/admin/services/stellar.html#jumpscale.packages.admin.services.stellar.StellarService">StellarService</a></li>
<li><a title="jumpscale.packages.backup.services.system_backup.SystemBackupService" href="../../packages/backup/services/system_backup.html#jumpscale.packages.backup.services.system_backup.SystemBackupService">SystemBackupService</a></li>
<li><a title="jumpscale.packages.billing.services.billing.BillingService" href="../../packages/billing/services/billing.html#jumpscale.packages.billing.services.billing.BillingService">BillingService</a></li>
</ul>
<h3>Methods</h3>
<dl>
<dt id="jumpscale.tools.servicemanager.servicemanager.BackgroundService.job"><code class="name flex">
<span>def <span class="ident">job</span></span>(<span>self)</span>
</code></dt>
<dd>
<div class="desc"><p>Background job to be scheduled.
Should be implemented by any service that inherits from this class</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@abstractmethod
def job(self):
    &#34;&#34;&#34;
    Background job to be scheduled.
    Should be implemented by any service that inherits from this class
    &#34;&#34;&#34;
    pass</code></pre>
</details>
</dd>
</dl>
</dd>
<dt id="jumpscale.tools.servicemanager.servicemanager.ServiceManager"><code class="flex name class">
<span>class <span class="ident">ServiceManager</span></span>
<span>(</span><span>*args, **kwargs)</span>
</code></dt>
<dd>
<div class="desc"><p>A simple attribute-based namespace.</p>
<p>SimpleNamespace(**kwargs)</p>
<p>base class implementation for any class with fields which supports getting/setting raw data for any instance fields.</p>
<p>any instance can have an optional name and a parent.</p>
<pre><code class="language-python">class Person(Base):
    name = fields.String()
    age = fields.Float()

p = Person(name=&quot;ahmed&quot;, age=&quot;19&quot;)
print(p.name, p.age)
</code></pre>
<h2 id="args">Args</h2>
<dl>
<dt><strong><code>parent_</code></strong> :&ensp;<code>Base</code>, optional</dt>
<dd>parent instance. Defaults to None.</dd>
<dt><strong><code>instance_name_</code></strong> :&ensp;<code>str</code>, optional</dt>
<dd>instance name. Defaults to None.</dd>
<dt><strong><code>**values</code></strong></dt>
<dd>any given field values to initiate the instance with</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">class ServiceManager(Base):
    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        self.services = {}  # service objects
        self._scheduled = {}  # greenlets of scheduled services
        self._running = {}  # greenlets of currently running services
        self._pool = Pool(cpu_count())

    @staticmethod
    def seconds_to_next_interval(interval):
        &#34;&#34;&#34;Helper method to get seconds remaining to next_interval

        Arguments:
            interval (Any): next interval to which seconds remaining is calculated

        Returns:
            Real: number of seconds remaining until next interval

        Raises:
            ValueError: when the type of interval is not Real / CronTab object / CronTab string format
        &#34;&#34;&#34;
        if isinstance(interval, Real):
            return interval
        elif isinstance(interval, str):
            try:
                return CronTab(interval).next(default_utc=True)
            except Exception as e:
                raise j.exceptions.Value(str(e))
        elif isinstance(interval, CronTab):
            return interval.next(default_utc=True)
        else:
            raise j.exceptions.Runtime(f&#34;Unsupported interval type: {type(interval)}&#34;)

    @staticmethod
    def _load_service(path):
        &#34;&#34;&#34;Load the module in the service file path and get the service object

        Arguments:
            path (str): path of the service file

        Returns:
            service: service object defined in the service file
        &#34;&#34;&#34;
        module = j.tools.codeloader.load_python_module(path, force_reload=True)
        return module.service

    @staticmethod
    def __on_exception(greenlet):
        &#34;&#34;&#34;Callback to handle exception raised by service greenlet

        Arguments:
            greenlet (Greenlet): greenlet object
        &#34;&#34;&#34;
        message = f&#34;Service {greenlet.service.name} raised an exception: {greenlet.exception}&#34;
        j.tools.alerthandler.alert_raise(app_name=&#34;servicemanager&#34;, message=message, alert_type=&#34;exception&#34;)
        j.logger.exception(f&#34;Service {greenlet.service.name} raised an exception&#34;, exception=greenlet.exception)

    def __callback(self, greenlet):
        &#34;&#34;&#34;Callback runs after greenlet finishes execution

        Arguments:
            greenlet (Greenlet): greenlet object
        &#34;&#34;&#34;
        greenlet.unlink(self.__callback)
        if greenlet.service.name in self._running:
            self._running.pop(greenlet.service.name)

    def _schedule_service(self, service):
        &#34;&#34;&#34;Runs a service job and schedules it to run again every period (interval) specified by the service

        Arguments:
            service (BackgroundService): background service object
        &#34;&#34;&#34;
        if service.name not in self._running:
            greenlet = self._pool.apply_async(service.job)
            greenlet.link(self.__callback)
            greenlet.link_exception(self.__on_exception)
            greenlet.start()
            self._running[service.name] = greenlet
            self._running[service.name].service = service
        next_start = ceil(self.seconds_to_next_interval(service.interval))
        self._scheduled[service.name] = gevent.spawn_later(next_start, self._schedule_service, service=service)

    def start(self):
        &#34;&#34;&#34;Start the service manager and schedule default services
        &#34;&#34;&#34;
        # schedule default services
        for service in self.services.values():
            next_start = ceil(self.seconds_to_next_interval(service.interval))
            self._scheduled[service.name] = gevent.spawn_later(next_start, self._schedule_service, service=service)

    def stop(self):
        &#34;&#34;&#34;Stop all background services
        &#34;&#34;&#34;
        j.logger.info(&#34;Stopping background services&#34;)
        for service in list(self.services.keys()):
            self.stop_service(service)
        j.logger.info(&#34;Done stopping the background services&#34;)

    def add_service(self, service_name, service_path):
        &#34;&#34;&#34;Add a new background service to be managed and scheduled by the service manager

        Arguments:
            service_path (str): absolute path of the service file
        &#34;&#34;&#34;

        service = self._load_service(service_path)
        service.name = service_name

        if service in self.services.values():
            j.logger.debug(f&#34;Service {service.name} is already running. Reloading...&#34;)
            self.stop_service(service.name)

        next_start = 0 if service.schedule_on_start else ceil(self.seconds_to_next_interval(service.interval))
        self._scheduled[service.name] = gevent.spawn_later(next_start, self._schedule_service, service=service)
        self.services[service.name] = service
        j.logger.debug(f&#34;Service {service.name} is added.&#34;)

    def stop_service(self, service_name, block=True):
        &#34;&#34;&#34;Stop a running background service and unschedule it if it&#39;s scheduled to run again

        Arguments:
            service_name (str): name of the service to be stopped
            block (bool): wait for service job to finish. if False, service job will be killed without waiting
        &#34;&#34;&#34;
        if service_name not in self.services:
            raise j.exceptions.Value(f&#34;Service {service_name} is not running&#34;)

        # unschedule service if it&#39;s scheduled to run again
        if service_name in self._scheduled:
            greenlet = self._scheduled[service_name]
            greenlet.unlink(self.__callback)
            greenlet.kill()
            if not greenlet.dead:
                raise j.exceptions.Runtime(&#34;Failed to unschedule greenlet&#34;)
            self._scheduled.pop(service_name)

        # wait for service to finish if it&#39;s already running
        if service_name in self._running:
            greenlet = self._running[service_name]
            greenlet.unlink(self.__callback)
            if block:
                try:
                    j.logger.info(f&#34;Waiting the service {service_name} to finish&#34;)
                    greenlet.join()
                    j.logger.info(f&#34;Done waiting the service {service_name}&#34;)
                except Exception as e:
                    raise j.exceptions.Runtime(f&#34;Exception on waiting for greenlet: {str(e)}&#34;)
            else:
                try:
                    greenlet.kill()
                except Exception as e:
                    raise j.exceptions.Runtime(f&#34;Exception on killing greenlet: {str(e)}&#34;)
                if not greenlet.dead:
                    raise j.exceptions.Runtime(&#34;Failed to kill running greenlet&#34;)

        self.services.pop(service_name)</code></pre>
</details>
<h3>Ancestors</h3>
<ul class="hlist">
<li><a title="jumpscale.core.base.meta.Base" href="../../core/base/meta.html#jumpscale.core.base.meta.Base">Base</a></li>
<li>types.SimpleNamespace</li>
</ul>
<h3>Static methods</h3>
<dl>
<dt id="jumpscale.tools.servicemanager.servicemanager.ServiceManager.seconds_to_next_interval"><code class="name flex">
<span>def <span class="ident">seconds_to_next_interval</span></span>(<span>interval)</span>
</code></dt>
<dd>
<div class="desc"><p>Helper method to get seconds remaining to next_interval</p>
<h2 id="arguments">Arguments</h2>
<p>interval (Any): next interval to which seconds remaining is calculated</p>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>Real</code></dt>
<dd>number of seconds remaining until next interval</dd>
</dl>
<h2 id="raises">Raises</h2>
<dl>
<dt><code>ValueError</code></dt>
<dd>when the type of interval is not Real / CronTab object / CronTab string format</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@staticmethod
def seconds_to_next_interval(interval):
    &#34;&#34;&#34;Helper method to get seconds remaining to next_interval

    Arguments:
        interval (Any): next interval to which seconds remaining is calculated

    Returns:
        Real: number of seconds remaining until next interval

    Raises:
        ValueError: when the type of interval is not Real / CronTab object / CronTab string format
    &#34;&#34;&#34;
    if isinstance(interval, Real):
        return interval
    elif isinstance(interval, str):
        try:
            return CronTab(interval).next(default_utc=True)
        except Exception as e:
            raise j.exceptions.Value(str(e))
    elif isinstance(interval, CronTab):
        return interval.next(default_utc=True)
    else:
        raise j.exceptions.Runtime(f&#34;Unsupported interval type: {type(interval)}&#34;)</code></pre>
</details>
</dd>
</dl>
<h3>Methods</h3>
<dl>
<dt id="jumpscale.tools.servicemanager.servicemanager.ServiceManager.add_service"><code class="name flex">
<span>def <span class="ident">add_service</span></span>(<span>self, service_name, service_path)</span>
</code></dt>
<dd>
<div class="desc"><p>Add a new background service to be managed and scheduled by the service manager</p>
<h2 id="arguments">Arguments</h2>
<p>service_path (str): absolute path of the service file</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def add_service(self, service_name, service_path):
    &#34;&#34;&#34;Add a new background service to be managed and scheduled by the service manager

    Arguments:
        service_path (str): absolute path of the service file
    &#34;&#34;&#34;

    service = self._load_service(service_path)
    service.name = service_name

    if service in self.services.values():
        j.logger.debug(f&#34;Service {service.name} is already running. Reloading...&#34;)
        self.stop_service(service.name)

    next_start = 0 if service.schedule_on_start else ceil(self.seconds_to_next_interval(service.interval))
    self._scheduled[service.name] = gevent.spawn_later(next_start, self._schedule_service, service=service)
    self.services[service.name] = service
    j.logger.debug(f&#34;Service {service.name} is added.&#34;)</code></pre>
</details>
</dd>
<dt id="jumpscale.tools.servicemanager.servicemanager.ServiceManager.start"><code class="name flex">
<span>def <span class="ident">start</span></span>(<span>self)</span>
</code></dt>
<dd>
<div class="desc"><p>Start the service manager and schedule default services</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def start(self):
    &#34;&#34;&#34;Start the service manager and schedule default services
    &#34;&#34;&#34;
    # schedule default services
    for service in self.services.values():
        next_start = ceil(self.seconds_to_next_interval(service.interval))
        self._scheduled[service.name] = gevent.spawn_later(next_start, self._schedule_service, service=service)</code></pre>
</details>
</dd>
<dt id="jumpscale.tools.servicemanager.servicemanager.ServiceManager.stop"><code class="name flex">
<span>def <span class="ident">stop</span></span>(<span>self)</span>
</code></dt>
<dd>
<div class="desc"><p>Stop all background services</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def stop(self):
    &#34;&#34;&#34;Stop all background services
    &#34;&#34;&#34;
    j.logger.info(&#34;Stopping background services&#34;)
    for service in list(self.services.keys()):
        self.stop_service(service)
    j.logger.info(&#34;Done stopping the background services&#34;)</code></pre>
</details>
</dd>
<dt id="jumpscale.tools.servicemanager.servicemanager.ServiceManager.stop_service"><code class="name flex">
<span>def <span class="ident">stop_service</span></span>(<span>self, service_name, block=True)</span>
</code></dt>
<dd>
<div class="desc"><p>Stop a running background service and unschedule it if it's scheduled to run again</p>
<h2 id="arguments">Arguments</h2>
<p>service_name (str): name of the service to be stopped
block (bool): wait for service job to finish. if False, service job will be killed without waiting</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def stop_service(self, service_name, block=True):
    &#34;&#34;&#34;Stop a running background service and unschedule it if it&#39;s scheduled to run again

    Arguments:
        service_name (str): name of the service to be stopped
        block (bool): wait for service job to finish. if False, service job will be killed without waiting
    &#34;&#34;&#34;
    if service_name not in self.services:
        raise j.exceptions.Value(f&#34;Service {service_name} is not running&#34;)

    # unschedule service if it&#39;s scheduled to run again
    if service_name in self._scheduled:
        greenlet = self._scheduled[service_name]
        greenlet.unlink(self.__callback)
        greenlet.kill()
        if not greenlet.dead:
            raise j.exceptions.Runtime(&#34;Failed to unschedule greenlet&#34;)
        self._scheduled.pop(service_name)

    # wait for service to finish if it&#39;s already running
    if service_name in self._running:
        greenlet = self._running[service_name]
        greenlet.unlink(self.__callback)
        if block:
            try:
                j.logger.info(f&#34;Waiting the service {service_name} to finish&#34;)
                greenlet.join()
                j.logger.info(f&#34;Done waiting the service {service_name}&#34;)
            except Exception as e:
                raise j.exceptions.Runtime(f&#34;Exception on waiting for greenlet: {str(e)}&#34;)
        else:
            try:
                greenlet.kill()
            except Exception as e:
                raise j.exceptions.Runtime(f&#34;Exception on killing greenlet: {str(e)}&#34;)
            if not greenlet.dead:
                raise j.exceptions.Runtime(&#34;Failed to kill running greenlet&#34;)

    self.services.pop(service_name)</code></pre>
</details>
</dd>
</dl>
<h3>Inherited members</h3>
<ul class="hlist">
<li><code><b><a title="jumpscale.core.base.meta.Base" href="../../core/base/meta.html#jumpscale.core.base.meta.Base">Base</a></b></code>:
<ul class="hlist">
<li><code><a title="jumpscale.core.base.meta.Base.from_dict" href="../../core/base/meta.html#jumpscale.core.base.meta.Base.from_dict">from_dict</a></code></li>
<li><code><a title="jumpscale.core.base.meta.Base.to_dict" href="../../core/base/meta.html#jumpscale.core.base.meta.Base.to_dict">to_dict</a></code></li>
<li><code><a title="jumpscale.core.base.meta.Base.validate" href="../../core/base/meta.html#jumpscale.core.base.meta.Base.validate">validate</a></code></li>
</ul>
</li>
</ul>
</dd>
</dl>
</section>
</article>
<nav id="sidebar">
<h1>Index</h1>
<div class="toc">
<ul>
<li><a href="#description">Description</a></li>
<li><a href="#how-it-schedules-services">How it schedules services</a></li>
<li><a href="#immediately-schedule-service">Immediately schedule service</a></li>
<li><a href="#example-service">Example service</a></li>
</ul>
</div>
<ul id="index">
<li><h3>Super-module</h3>
<ul>
<li><code><a title="jumpscale.tools.servicemanager" href="index.html">jumpscale.tools.servicemanager</a></code></li>
</ul>
</li>
<li><h3><a href="#header-classes">Classes</a></h3>
<ul>
<li>
<h4><code><a title="jumpscale.tools.servicemanager.servicemanager.BackgroundService" href="#jumpscale.tools.servicemanager.servicemanager.BackgroundService">BackgroundService</a></code></h4>
<ul class="">
<li><code><a title="jumpscale.tools.servicemanager.servicemanager.BackgroundService.job" href="#jumpscale.tools.servicemanager.servicemanager.BackgroundService.job">job</a></code></li>
</ul>
</li>
<li>
<h4><code><a title="jumpscale.tools.servicemanager.servicemanager.ServiceManager" href="#jumpscale.tools.servicemanager.servicemanager.ServiceManager">ServiceManager</a></code></h4>
<ul class="">
<li><code><a title="jumpscale.tools.servicemanager.servicemanager.ServiceManager.add_service" href="#jumpscale.tools.servicemanager.servicemanager.ServiceManager.add_service">add_service</a></code></li>
<li><code><a title="jumpscale.tools.servicemanager.servicemanager.ServiceManager.seconds_to_next_interval" href="#jumpscale.tools.servicemanager.servicemanager.ServiceManager.seconds_to_next_interval">seconds_to_next_interval</a></code></li>
<li><code><a title="jumpscale.tools.servicemanager.servicemanager.ServiceManager.start" href="#jumpscale.tools.servicemanager.servicemanager.ServiceManager.start">start</a></code></li>
<li><code><a title="jumpscale.tools.servicemanager.servicemanager.ServiceManager.stop" href="#jumpscale.tools.servicemanager.servicemanager.ServiceManager.stop">stop</a></code></li>
<li><code><a title="jumpscale.tools.servicemanager.servicemanager.ServiceManager.stop_service" href="#jumpscale.tools.servicemanager.servicemanager.ServiceManager.stop_service">stop_service</a></code></li>
</ul>
</li>
</ul>
</li>
</ul>
</nav>
</main>
<footer id="footer">
<p>Generated by <a href="https://pdoc3.github.io/pdoc" title="pdoc: Python API documentation generator"><cite>pdoc</cite> 0.10.0</a>.</p>
</footer>
</body>
</html>
